<?php
require_once '../vendor/autoload.php'; require_once '../libs/php/funciones.php'; require_once '../libs/php/db_tools.php'; LimpiarEntradas(); use Firebase\JWT\JWT; $spb637ea = 'my_secret_key'; $spb01ffd = time(); if ($_SERVER['REQUEST_METHOD'] == 'POST') { $sp707a4f = $_SERVER['HTTP_AUTHORIZATION']; if (substr($sp707a4f, 0, 6) === 'Bearer') { $sp707a4f = str_replace('Bearer ', '', $sp707a4f); try { $spee103d = JWT::decode($sp707a4f, $spb637ea, array('HS256')); $sp5d0379 = strval($spee103d->data->usuario); if (isset($_POST['txtMensaje']) && $_POST['txtMensaje'] != '') { if (!preg_match('/^(?=.*[A-Za-z])[0-9A-Za-z !@#$%]{1,200}$/', $_POST['txtMensaje']) || !isset($_POST['cmbDestino'])) { echo 'El mensaje no se ha enviado.'; http_response_code(401); die; } } if (!isset($_FILES['fulAdjunto']['name']) || $_FILES['fulAdjunto']['name'] == '') { $sp151ff6 = validarArchivo($_FILES['fulAdjunto']); $spf3e04e = RegistrarMensajeDB($sp5d0379, $_POST['cmbDestino'], $_POST['txtMensaje'], $sp151ff6); if ($spf3e04e == TRUE) { echo 'El mensaje se ha enviado.'; http_response_code(200); die; } echo 'El mensaje NO se ha enviado.'; http_response_code(401); die; } else { $sp151ff6 = validarArchivo($_FILES['fulAdjunto']); if ($sp151ff6 == NULL) { echo 'El archivo es incorrecto.'; http_response_code(401); die; } $spf3e04e = RegistrarMensajeDB($sp5d0379, $_POST['cmbDestino'], $_POST['txtMensaje'], $sp151ff6); if ($spf3e04e == TRUE) { echo 'El mensaje se ha enviado.'; http_response_code(200); die; } echo 'El mensaje NO se ha enviado.'; http_response_code(401); die; } } catch (\Throwable $spbc0671) { echo 'Credenciales erroneas.'; http_response_code(401); die; } } else { echo 'Acceso no autorizado.'; http_response_code(401); die; } } if ($_SERVER['REQUEST_METHOD'] == 'GET') { $sp707a4f = $_SERVER['HTTP_AUTHORIZATION']; if (substr($sp707a4f, 0, 6) === 'Bearer') { $sp707a4f = str_replace('Bearer ', '', $sp707a4f); try { $spee103d = JWT::decode($sp707a4f, $spb637ea, array('HS256')); $sp5d0379 = strval($spee103d->data->usuario); if (isset($_GET['msjr']) && ($_GET['msjr'] = 'ok')) { $sp40df56 = ListarMensajesRDB($sp5d0379); if (isset($sp40df56)) { foreach ($sp40df56 as $spb637ea => $sp08694a) { echo '{Nombre => ' . $sp08694a['nombre'] . '} '; echo '{Menesaje => ' . $sp08694a['Mensaje'] . '} '; echo '{Foto => ' . $sp08694a['Foto'] . '} '; echo '{Fecha => ' . $sp08694a['Fecha_mensaje'] . '} '; echo '{Archivo => ' . $sp08694a['Archivo'] . '} '; http_response_code(200); die; } } echo 'No hay mensajes.'; http_response_code(401); die; } if (isset($_GET['msje']) && ($_GET['msje'] = 'ok')) { $spb9122a = ListarMensajesEDB($sp5d0379); if (isset($spb9122a)) { foreach ($spb9122a as $spb637ea => $sp08694a) { echo '{Nombre => ' . $sp08694a['nombre'] . '} '; echo '{Menesaje => ' . $sp08694a['Mensaje'] . '} '; echo '{Foto => ' . $sp08694a['Foto'] . '} '; echo '{Fecha => ' . $sp08694a['Fecha_mensaje'] . '} '; echo '{Archivo => ' . $sp08694a['Archivo'] . '} '; http_response_code(200); die; } } echo 'No hay mensajes.'; http_response_code(401); die; } } catch (\Throwable $spbc0671) { echo 'Credenciales erroneas.'; http_response_code(401); die; } } else { echo 'Acceso no autorizado.'; http_response_code(401); die; } }